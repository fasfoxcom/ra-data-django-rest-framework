{"version":3,"file":"ra-data-django-rest-framework.cjs.development.js","sources":["../src/tokenAuthProvider.ts","../src/index.ts"],"sourcesContent":["import { AuthProvider, fetchUtils } from 'ra-core';\n\nexport interface Options {\n  obtainAuthTokenUrl?: string;\n  tokenKey?: string;\n}\n\nfunction tokenAuthProvider(options: Options = {}): AuthProvider {\n  const opts = {\n    obtainAuthTokenUrl: '/api-token-auth/',\n    tokenKey: 'token',\n    ...options,\n  };\n  return {\n    login: async ({ username, password }) => {\n      const request = new Request(opts.obtainAuthTokenUrl, {\n        method: 'POST',\n        body: JSON.stringify({ username, password }),\n        headers: new Headers({ 'Content-Type': 'application/json' }),\n      });\n      const response = await fetch(request);\n      if (response.ok) {\n        localStorage.setItem('token', (await response.json())[opts.tokenKey]);\n        return;\n      }\n      if (response.headers.get('content-type') !== 'application/json') {\n        throw new Error(response.statusText);\n      }\n\n      const json = await response.json();\n      const error = json.non_field_errors;\n      throw new Error(error || response.statusText);\n    },\n    logout: () => {\n      localStorage.removeItem('token');\n      return Promise.resolve();\n    },\n    checkAuth: () =>\n      localStorage.getItem('token') ? Promise.resolve() : Promise.reject(),\n    checkError: error => {\n      const status = error.status;\n      if (status === 401 || status === 403) {\n        localStorage.removeItem('token');\n        return Promise.reject();\n      }\n      return Promise.resolve();\n    },\n    getPermissions: () => {\n      return Promise.resolve();\n    },\n  };\n}\n\nexport function createOptionsFromToken() {\n  const token = localStorage.getItem('token');\n  if (!token) {\n    return {};\n  }\n  return {\n    user: {\n      authenticated: true,\n      token: 'Token ' + token,\n    },\n  };\n}\n\nexport function fetchJsonWithAuthToken(url: string, options: object) {\n  return fetchUtils.fetchJson(\n    url,\n    Object.assign(createOptionsFromToken(), options)\n  );\n}\n\nexport default tokenAuthProvider;\n","import { stringify } from 'query-string';\nimport {\n  Identifier,\n  Pagination,\n  Sort,\n  Filter,\n  fetchUtils,\n  DataProvider,\n} from 'ra-core';\n\nexport {\n  default as tokenAuthProvider,\n  fetchJsonWithAuthToken,\n} from './tokenAuthProvider';\n\nconst getPaginationQuery = (pagination: Pagination) => {\n  return {\n    page: pagination.page,\n    page_size: pagination.perPage,\n  };\n};\n\nconst getFilterQuery = (filter: Filter) => {\n  const { q: search, ...otherSearchParams } = filter;\n  return {\n    ...otherSearchParams,\n    search,\n  };\n};\n\nexport const getOrderingQuery = (sort: Sort) => {\n  const { field, order } = sort;\n  return {\n    ordering: `${order === 'ASC' ? '' : '-'}${field}`,\n  };\n};\n\nexport default (\n  apiUrl: String,\n  httpClient: Function = fetchUtils.fetchJson\n): DataProvider => {\n  const getOneJson = (resource: String, id: Identifier) =>\n    httpClient(`${apiUrl}/${resource}/${id}/`).then(\n      (response: Response) => response.json\n    );\n\n  return {\n    getList: async (resource, params) => {\n      const query = {\n        ...getFilterQuery(params.filter),\n        ...getPaginationQuery(params.pagination),\n        ...getOrderingQuery(params.sort),\n      };\n      const url = `${apiUrl}/${resource}/?${stringify(query)}`;\n\n      const { json } = await httpClient(url);\n\n      // Map pk to id\n      json.results.map((item: any) => (item.id = item.pk));\n\n      return {\n        data: json.results,\n        total: json.count,\n      };\n    },\n\n    getOne: async (resource, params) => {\n      const data = await getOneJson(resource, params.id);\n      data.id = data.pk;\n      return {\n        data,\n      };\n    },\n\n    getMany: (resource, params) => {\n      return Promise.all(\n        params.ids.map(id => getOneJson(resource, id))\n      ).then(data => ({ data }));\n    },\n\n    getManyReference: async (resource, params) => {\n      const query = {\n        ...getFilterQuery(params.filter),\n        ...getPaginationQuery(params.pagination),\n        ...getOrderingQuery(params.sort),\n        [params.target]: params.id,\n      };\n      const url = `${apiUrl}/${resource}/?${stringify(query)}`;\n\n      const { json } = await httpClient(url);\n      return {\n        data: json.results,\n        total: json.count,\n      };\n    },\n\n    update: async (resource, params) => {\n      const { json } = await httpClient(`${apiUrl}/${resource}/${params.id}/`, {\n        method: 'PATCH',\n        body: JSON.stringify(params.data),\n      });\n      return { data: json };\n    },\n\n    updateMany: (resource, params) =>\n      Promise.all(\n        params.ids.map(id =>\n          httpClient(`${apiUrl}/${resource}/${id}/`, {\n            method: 'PATCH',\n            body: JSON.stringify(params.data),\n          })\n        )\n      ).then(responses => ({ data: responses.map(({ json }) => json.id) })),\n\n    create: async (resource, params) => {\n      const { json } = await httpClient(`${apiUrl}/${resource}/`, {\n        method: 'POST',\n        body: JSON.stringify(params.data),\n      });\n      return {\n        data: { ...json },\n      };\n    },\n\n    delete: (resource, params) =>\n      httpClient(`${apiUrl}/${resource}/${params.id}/`, {\n        method: 'DELETE',\n      }).then(() => ({ data: params.previousData })),\n\n    deleteMany: (resource, params) =>\n      Promise.all(\n        params.ids.map(id =>\n          httpClient(`${apiUrl}/${resource}/${id}/`, {\n            method: 'DELETE',\n          })\n        )\n      ).then(responses => ({ data: responses.map(({ json }) => json.id) })),\n  };\n};\n"],"names":["tokenAuthProvider","options","opts","obtainAuthTokenUrl","tokenKey","login","username","password","request","Request","method","body","JSON","stringify","headers","Headers","fetch","response","get","Error","statusText","json","error","non_field_errors","ok","localStorage","setItem","logout","removeItem","Promise","resolve","checkAuth","getItem","reject","checkError","status","getPermissions","createOptionsFromToken","token","user","authenticated","fetchJsonWithAuthToken","url","fetchUtils","fetchJson","Object","assign","getPaginationQuery","pagination","page","page_size","perPage","getFilterQuery","filter","search","q","otherSearchParams","getOrderingQuery","sort","field","order","ordering","apiUrl","httpClient","getOneJson","resource","id","then","getList","params","query","results","map","item","pk","data","total","count","getOne","getMany","all","ids","getManyReference","target","update","updateMany","responses","create","previousData","deleteMany"],"mappings":"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"}